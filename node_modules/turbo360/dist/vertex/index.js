"use strict";var Promise=require("bluebird"),superagent=require("superagent"),helper=require("../utils/Helper"),fs=require("fs"),path=require("path"),TURBO_VECTOR_API_KEY_HEADER="Turbo-Vector-API-Key",NODE_MODULES_PATH="win32"==process.platform?"node_modules\\turbo360\\dist\\vertex":"node_modules/turbo360/dist/vertex",BUCKET="turbo360-vertex",fetchTextFile=function(e){return new Promise(function(r,n){superagent.get(e).query(null).end(function(e,t){if(e)return void n(e);r(t.text)})})},readFile=function(e){return new Promise(function(r,n){fs.readFile(e,"utf8",function(e,t){if(e)return void n(e);r(t)})})},Vertex=function(e){var r=e,n=null,t=function(e){return new Promise(function(t,i){if(0==helper.validateSiteId(r))return void i(new Error("Please Set Your TURBO_APP_ID"));helper.fetchSite(r,!1).then(function(r){if(n=r,"dev"==e){var t=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return readFile(t)}return null}).then(function(e){if(null==e)t(n);else try{var r=Object.assign({},n);r.globalConfig=JSON.parse(e),t(r)}catch(e){t(n)}}).catch(function(e){i(e)})})},i=function(e){return new Promise(function(n,t){if(null==e)return void t(new Error("Please specify page name"));if(0==e.length)return void t(new Error("Please specify page name"));var i=e.toLowerCase().trim(),o="https://cdn.turbo360-vertex.com/pages/"+r.site_id+"-"+i+".json";superagent.get(o).query(null).set("Accept","application/json").end(function(e,r){if(e)return void t(e);n(r.body)})})},o=function(e,n,t){return new Promise(function(i,o){if(null==e)return void o(new Error("Please specify template name"));if(0==e.length)return void o(new Error("Please specify template name"));if("dev"==t){var u=path.join(__dirname,"/views/"+e+".mustache").replace(NODE_MODULES_PATH,"");return void fs.readFile(u,"utf8",function(e,r){if(e)return void o(e);i(r)})}helper.fetchSite(r).then(function(r){if(r.api.key!=n)return void o(new Error("Unauthorized"));var t="https://cdn.turbo360-vertex.com/"+r.slug+"/views/"+e+".mustache";return helper.fetchTextFile(t)}).then(function(e){i(e)}).catch(function(e){o(e)})})},u=function(e,t){return new Promise(function(i,o){if("dev"==t){var u=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return void fs.readFile(u,"utf8",function(e,r){if(e)return void o(e);try{i(JSON.parse(r))}catch(e){o(e)}})}if(e.length<20)return void o(new Error("Please Set Your TURBO_API_KEY"));helper.fetchSite(r,!1).then(function(r){if(r.api.key!=e)return void o(new Error("Unauthorized"));n=r,i(r.globalConfig)}).catch(function(e){o(e)})})};return{pageData:i,rawTemplate:o,pageConfig:function(e,t,i){return new Promise(function(o,u){if(null==e)return void u(new Error("Please specify page name"));if(0==e.length)return void u(new Error("Please specify page name"));if("dev"==i){var a=path.join(__dirname,"/pages/"+e+".json").replace(NODE_MODULES_PATH,"");return void fs.readFile(a,"utf8",function(e,r){if(e)return void u(new Error("Config file not found."));try{o(JSON.parse(r))}catch(e){u(e)}})}if(t.length<20)return void u(new Error("Please Set Your TURBO_API_KEY"));helper.fetchSite(r).then(function(r){if(r.api.key!=t)return void u(new Error("Unauthorized"));n=r;var i="https://s3.amazonaws.com/"+BUCKET+"/pages/"+n.slug+"/"+e+".txt";return helper.fetchTextFile(i)}).then(function(e){var r=JSON.parse(e);o(r)}).catch(function(r){return null==r.message?void u(r):"Forbidden"==r.message?void u(new Error(e+" config not found. For more information - https://docs.turbo360.co/page-configuration")):void u(r)})})},updatePage:function(t,i,o){return new Promise(function(u,a){if(0==helper.validateSiteId(r))return void a(new Error("Please Set Your TURBO_APP_ID"));if(r.site_id.length<20)return void a(new Error("Please Set Your TURBO_APP_ID"));if(null==o)return void a(new Error("Please Set Your TURBO_API_KEY"));if(o.length<20)return void a(new Error("Please Set Your TURBO_API_KEY"));if(null==t)return void a(new Error("Please specify page name"));if(0==t.length)return void a(new Error("Please specify page name"));var f=t+".txt";helper.fetchSite(r).then(function(r){if(r.api.key!=o)return void a(new Error("Unauthorized"));n=r;var s={bucket:BUCKET,filename:f,filetype:"text/plain",folder:"pages/"+n.slug},l=e.turbo_url+"/account/uploadurl";superagent.post(l).send(s).set("Accept","application/json").end(function(e,r){if(e)return void a(e);if("success"!=r.body.confirmation)return void a(new Error(r.body.message));var n={name:f,type:"text/plain"};superagent.put(r.body.data.upload).send(i).set("Content-Type",n.type).end(function(e,r){if(e)return void a(e);u({page:t,status:t+" successfully updated"})})})}).catch(function(e){a(e)})})},globalConfig:u,currentApp:t}};module.exports=Vertex;