var Promise=require("bluebird"),superagent=require("superagent"),IndexDB=require("./IndexDB"),helper=require("./Helper"),Auth=function(e){var r=e;return{login:function(n){return new Promise(function(t,o){return 0==helper.validateSiteId(e)?void o(new Error("Please Set Your TURBO_APP_ID")):null==n?void o(new Error("Post parameters required.")):(n.site=r.site_id,void superagent.post(r.base_url+"/auth/login").send(n).set("Accept","application/json").end(function(e,r){if(e)return void o(e);var n=r.body;if("success"!=n.confirmation){var i=n.message||"Login Failed";return void o(new Error(i))}var u=n.user||n.result;t(u)}))})},logout:function(){return new Promise(function(n,t){if(0==helper.validateSiteId(e))return void t(new Error("Please Set Your TURBO_APP_ID"));if("undefined"==typeof window)return void n(null);var o=IndexDB(r);if(null==o)return void n(null);o.dbTransaction(function(e,o){if(e)return void t(e);var i=o.delete(r.site_id);i.onsuccess=function(){console.log("Token Removed"),n(null)},i.onerror=function(e){t(e.target)}})})},currentUser:function(){return new Promise(function(e,n){if("undefined"==typeof window)return void e(null);var t=IndexDB(r);if(null==t)return void e(null);t.dbTransaction(function(t,o){if(t)return void n(t);var i=o.get(r.site_id);i.onsuccess=function(){if(null==i.result)return void n(new Error("Not Logged In"));superagent.get(r.base_url+"/auth/currentuser").query(null).set("Accept","application/json").set("turbo-token",i.result.token).end(function(r,t){if(r)return void n(r);if("success"!=t.body.confirmation)return void n(new Error(t.body.message));var o=t.body.user||t.body.result;e(o)})},i.onerror=function(e){n(e.target)}})})},createUser:function(n){return new Promise(function(t,o){return 0==helper.validateSiteId(e)?void o(new Error("Please Set Your TURBO_APP_ID")):null==n?void o(new Error("Post parameters required.")):(n.site=r.site_id,void superagent.post(r.base_url+"/auth/createuser").send(n).set("Accept","application/json").end(function(e,n){if(e)return void o(e);var i=n.body;if("success"!=i.confirmation){var u=i.message||"Registration Failed";return void o(new Error(u))}var s=i.user||i.result;if("undefined"==typeof window)return console.log("Window undefined!"),void t(s);var d=IndexDB(r);if(null==d)return void t(s);d.dbTransaction(function(e,n){if(e)return void o(e);n.put({id:r.site_id,token:i.token}),t(s)})}))})},fetchUser:function(n){return new Promise(function(t,o){if(0==helper.validateSiteId(e))return void o(new Error("Please Set Your TURBO_APP_ID"));superagent.get(r.base_url+"/api/user/"+n).query(null).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void o(e);if("success"!=r.body.confirmation)return void o(new Error(r.body.message));var n=r.body.result||r.body.user;t(n)})})},updateUser:function(n,t){return new Promise(function(o,i){return 0==helper.validateSiteId(e)?void i(new Error("Please Set Your TURBO_APP_ID")):null==t?void i(new Error("Updated parameters required.")):void superagent.put(r.base_url+"/api/user/"+n).send(t).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void i(e);if("success"!=r.body.confirmation)return void i(new Error(r.body.message));var n=r.body.result||r.body.user;o(n)})})},deleteUser:function(n){return new Promise(function(t,o){if(0==helper.validateSiteId(e))return void o(new Error("Please Set Your TURBO_APP_ID"));superagent.delete(r.base_url+"/api/user/"+n).set(helper.standardHeaders(e)).end(function(e,r){if(e)return void o(e);if("fail"==r.body.confirmation)return void o(new Error(r.body.message));var n=r.body.result||r.body.results;t(n)})})}}};module.exports=Auth;