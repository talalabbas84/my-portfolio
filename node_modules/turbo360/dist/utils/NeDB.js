var superagent=require("superagent"),fs=require("fs"),helper=require("./Helper"),BUCKET="turbo360-vertex";const readFile=function(e){return new Promise(function(n,r){fs.readFile(e,"utf8",function(e,t){if(e)return void r(e);n(t)})})};var writeFile=function(e,n){return new Promise(function(r,t){fs.writeFile(e,n,function(e){if(e)return void t(e);r(n)})})},NeDB=function(e){var n=e,r=function(e,n){return new Promise(function(e,r){if(fs.existsSync(n))return void e({found:!0});e({found:!1})})},t=function(r,t,i){return new Promise(function(o,u){if(0==helper.validateSiteId(e))return void u(new Error("Please Set Your TURBO_APP_ID"));if(n.site_id.length<20)return void u(new Error("Please Set Your TURBO_APP_ID"));if(null==i)return void u(new Error("Missing API Key"));if(i.length<20)return void u(new Error("Missing API Key"));var s=r+".txt",l=null,c=null;helper.fetchSite(n).then(function(e){return e.api.key!=i?void u(new Error("Unauthorized")):(c=e,readFile(t))}).then(function(n){l=n;var t={bucket:BUCKET,filename:s,filetype:"text/plain",folder:"stores/"+c.slug},i=e.turbo_url+"/account/uploadurl";superagent.post(i).send(t).set("Accept","application/json").end(function(e,n){if(e)return void u(e);if("success"!=n.body.confirmation)return void u(new Error(n.body.message));var t={name:s,type:"text/plain"};superagent.put(n.body.data.upload).send(l).set("Content-Type",t.type).end(function(e,n){if(e)return void u(e);o({collection:r,status:r+" successfully synced"})})})}).catch(function(e){u(e)})})};return{loadCollection:function(r,t,i){return new Promise(function(o,u){return 0==helper.validateSiteId(e)?void u(new Error("Please Set Your TURBO_APP_ID")):n.site_id.length<20?void u(new Error("Please Set Your TURBO_APP_ID")):null==i?void u(new Error("Missing API Key")):i.length<20?void u(new Error("Missing API Key")):void helper.fetchSite(n).then(function(e){if(e.api.key!=i)return void u(new Error("Unauthorized"));var n="https://s3.amazonaws.com/"+BUCKET+"/stores/"+e.slug+"/"+r+".txt";return helper.fetchTextFile(n)}).then(function(e){return writeFile(t,e)}).then(function(e){o(e)}).catch(function(e){u(e)})})},syncCollection:t,checkCollectionFile:r}};module.exports=NeDB;