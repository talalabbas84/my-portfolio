"use strict";var superagent=require("superagent"),path=require("path"),fs=require("fs"),TURBO_URL="https://turbo-dashboard.herokuapp.com",NODE_MODULES_PATH="win32"==process.platform?"node_modules\\vertex360\\dist\\vertex":"node_modules/vertex360/dist/vertex",currentSite=null,isValidApp=function(e){return null==e.TURBO_APP_ID?"TURBO_APP_ID":"<TURBO_APP_ID>"==e.TURBO_APP_ID?"TURBO_APP_ID":e.TURBO_APP_ID.length<20?"TURBO_APP_ID":null==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":"<TURBO_APP_SLUG>"==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":e.TURBO_APP_SLUG.length<6?"TURBO_APP_SLUG":null==e.TURBO_API_KEY?"TURBO_API_KEY":"<TURBO_API_KEY>"==e.TURBO_API_KEY?"TURBO_API_KEY":e.TURBO_API_KEY.length<20?"TURBO_API_KEY":null},getRequest=function(e,t,n){return null==n&&(n={Accept:"application/json"}),new Promise(function(r,i){superagent.get(e).query(t).set(n).end(function(e,t){if(e)return void i(e);var o=null;"application/json"==n.Accept&&(o=t.body||t.text),r(o)})})},postRequest=function(e,t,n){return null==n&&(n={Accept:"application/json"}),new Promise(function(r,i){superagent.post(e).send(t).set(n).end(function(e,t){if(e)return void i(e);var o=null;"application/json"==n.Accept&&(o=t.body||t.text),r(o)})})},fetchTextFile=function(e){return new Promise(function(t,n){superagent.get(e).query(null).end(function(e,r){if(e)return void n(e);t(r.text)})})},resetPage=function(e,t){return new Promise(function(n,r){if(null==e)return void r(new Error("Missing pageName argument"));if(null==t)return void r(new Error("Missing appslug argument"));var i=e+".txt";fetchTextFile("https://s3.amazonaws.com/turbo360-vertex/pages/"+t+"/"+i).then(function(e){fs.writeFileSync("/tmp/"+i,e);var t=JSON.parse(e);n(t)}).catch(function(e){r(e)})})},fetchSite=function(e,t){return null==t&&(t=!0),new Promise(function(n,r){if(null!=currentSite&&1==t)return void n(currentSite);var i=TURBO_URL+"/api/site/"+e;superagent.get(i).query(null).set("Accept","application/json").end(function(e,t){if(e)return void r(e);var i=t.body;if("success"!=i.confirmation)return void r(new Error(i.message));currentSite=i.result,n(currentSite)})})},globalConfig=function(e){return new Promise(function(t,n){if("dev"==e.TURBO_ENV){var r=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return void fs.readFile(r,"utf8",function(e,r){if(e)return void n(e);try{t(JSON.parse(r))}catch(e){n(e)}})}var i=isValidApp(e);if(null!=i)return void n(new Error("Please Set Your "+i));fetchSite(e.TURBO_APP_ID,!1).then(function(r){if(r.api.key!=e.TURBO_API_KEY)return void n(new Error("Unauthorized"));currentSite=r,t(r.globalConfig)}).catch(function(e){n(e)})})};module.exports={get:getRequest,post:postRequest,fetchTextFile:fetchTextFile,fetchSite:fetchSite,globalConfig:globalConfig,isValidApp:isValidApp,resetPage:resetPage,slugVersion:function(e,t){var n=e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"");if(null==t)return n.toLowerCase();if(t<=0)return n.toLowerCase();for(var r="",i="abcdefghijklmnopqrstuvwxyz0123456789",o=0;o<t;o++)r+=i.charAt(Math.floor(Math.random()*i.length));return n.toLowerCase()+"-"+r},truncateText:function(e,t){return e.length<t?e:e.substring(0,t)+"..."},formattedDate:function(e){var t={weekday:"long",year:"numeric",month:"long",day:"numeric"};return null==e&&(e=new Date),e.toLocaleDateString("en-US",t)},scrapeInstagram:function(e,t){return null==t&&(t=70),new Promise(function(n,r){getRequest("https://www.instagram.com/"+e+"/?__a=1").then(function(e){var r=[];return null==e?void n(r):null==e.graphql?void n(r):null==e.graphql.user?void n(r):null==e.graphql.user.edge_owner_to_timeline_media?void n(r):null==e.graphql.user.edge_owner_to_timeline_media.edges?void n(r):(e.graphql.user.edge_owner_to_timeline_media.edges.forEach(function(e){if(null!=e.node){var n={};n.shortcode=e.node.shortcode,n.image=e.node.thumbnail_src,n.caption=e.node.edge_media_to_caption.edges[0].node.text,n.caption=n.caption.substring(0,t)+"...",r.push(n)}}),void n(r))}).catch(function(e){r(e)})})},scrapePreview:function(e,t){return new Promise(function(n,r){if(null==e||void 0==e)return void n(null);superagent.post("https://platform.turbo360-vector.com/scrapepreview").send({text:e,limit:t}).set("Accept","application/json").end(function(e,t){if(e)return void r(e);var i=t.body;n(i)})})}};