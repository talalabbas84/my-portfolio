"use strict";function TemplateEngine(e){return e&&Object.keys(e).forEach(function(t){if(!TemplateEngine.__settings.hasOwnProperty(t))throw"hogan-middleware: unknown setting, attempted to set value for "+t;TemplateEngine.__settings[t]=e[t]}),TemplateEngine}function findTemplates(e,t){return ReadDir.readSync(e,t,ReadDir.ABSOLUTE_PATHS)}function readTemplate(e){return{content:Hogan.compile(FS.readFileSync(e,"utf-8")),path:stripFileExtension(e)}}function stripFileExtension(e){return e.replace(/(.+)\.[a-z]+/,"$1")}var Hogan=require("hogan.js"),ReadDir=require("readdir"),Path=require("path"),FS=require("fs"),debug=require("debug")("hogan"),NODE_MODULES_PATH="win32"==process.platform?"node_modules\\vertex360\\dist\\vertex":"node_modules/vertex360/dist/vertex";TemplateEngine.__settings={filter:["**.mustache"],flatten:!0,watch:!0},TemplateEngine._watches=[],TemplateEngine.__express=function(e,t,n){var a=stripFileExtension(Path.relative(t.settings.views,e)),i=TemplateEngine._getTemplates(t.settings.views),r=null,s=null,l=Path.join(__dirname,"/pages/"+a+".json").replace(NODE_MODULES_PATH,""),p=null;if(FS.existsSync(l)){var g=FS.readFileSync(l);try{null==t.page&&(p=JSON.parse(g),t.page=p)}catch(s){}}try{r=i[a].render(t,i)}catch(e){s=e}finally{n(s,r)}},TemplateEngine._getTemplates=function(e){return TemplateEngine.__templates||(TemplateEngine._refreshTemplates(e),FS.watch(e,{persistent:!1},function(t,n,a){return TemplateEngine._refreshTemplates(e)})),TemplateEngine.__templates},TemplateEngine._refreshWatches=function(e){if(!1===TemplateEngine.__settings.watch)return void debug("Refreshing watched directories has been disabled.");debug("Refreshing watched directories"),TemplateEngine._watches.splice(0).forEach(function(e){e.close()}),ReadDir.readSync(e,["**/"],ReadDir.ABSOLUTE_PATHS+ReadDir.INCLUDE_DIRECTORIES).forEach(function(t){debug(" [WATCH] %s",t),TemplateEngine._watches.push(FS.watch(t,{persistent:!1},TemplateEngine._refreshTemplates.bind(TemplateEngine,e)))})},TemplateEngine._refreshTemplates=function(e){debug("Refreshing templates for %s",e),TemplateEngine._refreshWatches(e);var t=TemplateEngine.__settings;findTemplates(e,t.filter).map(readTemplate).reduce(function(n,a){return t.flatten&&(n[Path.basename(a.path)]=a.content),n[Path.relative(e,a.path)]=a.content,n},TemplateEngine.__templates={}),debug("Refreshing templates complete")},module.exports=TemplateEngine;