"use strict";var _prototypeProperties=function(e,t,n){t&&Object.defineProperties(e,t),n&&Object.defineProperties(e.prototype,n)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},express=require("express"),path=require("path"),Router=require("./Router"),utils=require("./utils"),BASE_DIR=__dirname+"/../../../../",APIRouter=function(){function e(t){_classCallCheck(this,e),this.site_id=t.site_id,this.api_key=t.api_key,this.env=t.env||"dev",this.tmp=t.tmp||"/tmp",this.turbo=require("turbo360")({site_id:t.site_id}),this.checkCollectionDB=this.checkCollectionDB.bind(this),this.createRouter=this.createRouter.bind(this),this.populateRouter=this.populateRouter.bind(this),this.local=this.local.bind(this),this.prod=this.prod.bind(this)}return _prototypeProperties(e,null,{checkCollectionDB:{value:function(e){var t=this,n=path.join(BASE_DIR,this.tmp),i="dev"==this.env?n+"/"+e+".db":this.tmp+"/"+e+".db";return new Promise(function(n,o){t.turbo.checkCollectionFile(e,i).then(function(n){return n.found?null:t.turbo.loadCollection(e,i,t.api_key)}).then(function(e){n(e)}).catch(function(e){o(e)})})},writable:!0,configurable:!0},createRouter:{value:function(e){return"dev"==e?new express.Router:new Router},writable:!0,configurable:!0},populateRouter:{value:function(e,t,n){var i=this;e.get("/",function(e,n){var i=[];Object.keys(t).forEach(function(e){var n=t[e],o=new n;i.push({name:e,collectionName:o.collectionName(),schema:o.schema()})}),n.json({confirmation:"success",data:i})}),e.post("/",function(e,t){var n=e.body.task;if(null==n)return void t.json({confirmation:"fail",message:"Missing task parameter"});if("resetpage"==n){var i=e.body.page;if(null==i)return void t.json({confirmation:"fail",message:"Missing page parameter"});var o=e.body.appslug;return null==o?void t.json({confirmation:"fail",message:"Missing appslug parameter"}):void utils.resetPage(i,o).then(function(e){t.json({confirmation:"success",data:e})}).catch(function(e){t.json({confirmation:"fail",message:e.message})})}t.json({confirmation:"fail",message:"Invalid task: "+n})}),e.get("/:resource",function(e,n){var o=t[e.params.resource];if(null==o)return void n.json({confirmation:"fail",message:"Invalid resource"});var r=new o;i.checkCollectionDB(r.collectionName()).then(function(t){return r.get(e.query)}).then(function(e){n.json({confirmation:"success",data:e})}).catch(function(e){n.json({confirmation:"fail",message:e.message})})}),e.get("/:resource/:id",function(e,n){var o=t[e.params.resource];if(null==o)return void n.json({confirmation:"fail",message:"Invalid resource"});var r=new o;i.checkCollectionDB(r.collectionName()).then(function(t){return r.getById(e.params.id)}).then(function(e){n.json({confirmation:"success",data:e})}).catch(function(e){n.json({confirmation:"fail",message:e.message})})}),e.post("/:resource",function(e,n){var o=t[e.params.resource];if(null==o)return void n.json({confirmation:"fail",message:"Invalid resource"});var r=new o;i.checkCollectionDB(r.collectionName()).then(function(t){return r.post(e.body)}).then(function(e){n.json({confirmation:"success",data:e})}).catch(function(e){n.json({confirmation:"fail",message:e.message})})}),e.put("/:resource/:id",function(e,n){var o=t[e.params.resource];if(null==o)return void n.json({confirmation:"fail",message:"Invalid resource"});var r=new o;i.checkCollectionDB(r.collectionName()).then(function(t){var n=e.body;return delete n.timestamp,r.put(e.params.id,n)}).then(function(e){n.json({confirmation:"success",data:e})}).catch(function(e){n.json({confirmation:"fail",message:e.message})})}),e.delete("/:resource/:id",function(e,n){var o=t[e.params.resource];if(null==o)return void n.json({confirmation:"fail",message:"Invalid resource"});var r=new o;i.checkCollectionDB(r.collectionName()).then(function(t){var n=e.params.id;return r.delete(n,null)}).then(function(){n.json({confirmation:"success",data:{id:e.params.id}})}).catch(function(e){n.json({confirmation:"fail",message:e.message})})})},writable:!0,configurable:!0},local:{value:function(e){var t=this.createRouter("dev");return this.populateRouter(t,e),t},writable:!0,configurable:!0},prod:{value:function(e){var t=this.createRouter("prod");return this.populateRouter(t,e),t},writable:!0,configurable:!0},router:{value:function(e){var t=this.createRouter(this.env);return this.populateRouter(t,e),t},writable:!0,configurable:!0}}),e}();module.exports=APIRouter;